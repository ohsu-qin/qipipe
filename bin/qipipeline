#!/usr/bin/env python
"""
Runs the QIN pipeline.
"""

import sys, os
import argparse
from ConfigParser import ConfigParser as Config
import logging
# Defer importing the application modules until the logging level has been set.


def main(argv=sys.argv):
    # Parse the command line arguments.
    args = _parse_arguments()
    
    # Configure the logger.
    if args.log:
        logging.basicConfig(filename=args.log)
    if args.log_level:
        logging.getLogger().setLevel(args.log_level)
    
    # Import the application now, after logging has been set.
    from qipipe.pipelines import qipipeline as qip
    
    # The options.
    opts = {}
    if args.output:
        opts['dest'] = args.output
    if args.work:
        opts['work'] = args.work
    if args.registration == False:
        opts['registration'] = False
    if args.pk_mapping == False:
        opts['pk_mapping'] = False
        
    # If there is a config file, then load the additional options.
    if args.config:
        config = Config()
        config.read(args.config)
        opts.merge(config)
    
    # Run the QIN workflow.
    qip.run(args.collection, *args.files, **opts)

    return 0

def _parse_arguments():
    """Parses the command line arguments."""
    parser = argparse.ArgumentParser()

    coll_grp = parser.add_mutually_exclusive_group(required=True)
    coll_grp.add_argument('-b', '--breast', help='the breast TCIA collection',
        dest='collection', action='store_const', const='Breast')
    coll_grp.add_argument('-s', '--sarcoma', help='the sarcoma TCIA collection',
        dest='collection', action='store_const', const='Sarcoma')
    
    verbosity_grp = parser.add_mutually_exclusive_group()
    verbosity_grp.add_argument('-q', '--quiet', help="don't print messages", dest='log_level',
        action='store_const', const=logging.ERROR)
    verbosity_grp.add_argument('-v', '--verbose', help='print informational messages', dest='log_level',
        action='store_const', const=logging.INFO)
    verbosity_grp.add_argument('-d', '--debug', help='print debug messages', dest='log_level',
        action='store_const', const=logging.DEBUG)
    
    parser.add_argument('--no-registration', help='only perform the staging workflow', dest='registration',
        action='store_false')
    parser.add_argument('--no-pk-mapping', help="don't perform the PK mapping workflow", dest='pk_mapping',
        action='store_false')

    parser.add_argument('-c', '--config', help="the workflow configuration file", dest='config')
    
    parser.add_argument('-l', '--log', help='the log file')
    parser.add_argument('-o', '--output', help='the destination directory (default current directory)')
    parser.add_argument('-w', '--work', help='the work directory (default a new temp directory)')
    parser.add_argument('subject_dirs', help='the input AIRC DICOM subject directories',
        metavar='DIR', nargs='+')

    return parser.parse_args()


if __name__ == '__main__':
    sys.exit(main())
