#!/usr/bin/env python
"""
Creates well-formed symbolic links to AIRC concatenated DICOM files.
"""

import sys
import os
import getopt
import logging
from qipipe.staging import group_dicom_files

help_message = """
lndicom options DIR...
Options:
    -C --changeto\tChange to the given target directory
    -i --include\tThe source image file name pattern
    -p --visit\tThe source visit subdirectory pattern
    -r --replace\tReplace the existing target image file links
    -t --delta\tThe delta directory to hold new target visit directories
    -f --file\tA file containing the source patient directories
    -q, --quiet\tSuppress messages
    -v, --verbose\tPrint verbose messages
    -h --help\tPrint this help message
"""


class Usage(Exception):

    def __init__(self, msg):
        self.msg = msg


def main(argv=None):
    if argv is None:
        argv = sys.argv
    try:
        try:
            opts, args = getopt.getopt(argv[1:], 'C:i:p:rt:hf:qv', ['changeto=', 'include=', 'visit=', 'replace', 'delta=', 'help', 'file=', 'quiet' , 'verbose'])
        except getopt.error, msg:
            raise Usage(msg)

        target = delta = None
        # the link options
        lopts = {}
        # option processing
        for option, value in opts:
            if option in ('-C', '--changeto'):
                lopts['target'] = value
            elif option in ('-h', '--help'):
                print help_message
                return 0
            elif option in ('-i', '--include'):
                lopts['include'] = value
            elif option in ('-p', '--visit'):
                lopts['visit'] = value
            elif option in ('-r', '--replace'):
                lopts['replace'] = True
            elif option in ('-t', '--delta'):
                lopts['delta'] = value
            elif option in ('-q', '--quiet'):
                logging.basicConfig(level=logging.ERROR)
            elif option in ('-v', '--verbose'):
                logging.basicConfig(level=logging.DEBUG)
            elif option in ('-f', '--file'):
                farg = value
                if farg == '-':
                    fs = sys.stdin
                else:
                    fs = open(farg)
                args[:] = [s.strip() for s in fs.readlines()]
        args.append(lopts)

        staging.group_dicom_files(*args)

    except Usage, err:
        print >> sys.stderr, sys.argv[0].split('/')[-1] + ': ' + str(err.msg)
        return 2

    return 0

if __name__ == '__main__':
    sys.exit(main())
