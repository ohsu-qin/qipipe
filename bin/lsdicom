#!/usr/bin/env python
"""
Prints each patient-study-series-image path in a DICOM image hierarchy.
The format of each path is a line of tab-delimited fields.
"""

import sys
import os
import getopt
from qipipe.helpers import dicom_helper

help_message = """
lsimg options FILE...
Options:
    -s --summary\tPrint only the Patient ID, Study Instance UID, Series Instance UID and Instance Number tags
    -t --tags\tThe comma-separated tags to print (default is all non-pixel tags)
    -n --header\tPrint a header line consisting of the DICOM tag names
    -v\t\tPrint informational messages
    -h --help\tPrint this help message
"""


class Usage(Exception):
    
    def __init__(self, msg):
        self.msg = msg


def main(argv=None):
    if argv is None:
        argv = sys.argv
    summary = False
    tags = None
    try:
        try:
            opts, args = getopt.getopt(argv[1:], 'nst:hv', ['tags=', 'help', 'verbose'])
        except getopt.error, msg:
            raise Usage(msg)
        
        # option processing
        for opt, val in opts:
            if opt in ('-s', '--summary'):
                summary = True
            elif opt in ('-t', '--tags'):
                tags = val.split(',')
            elif opt in ('-n', '--names'):
                header = True
            elif opt == '-v':
                verbose = True
            elif opt in ('-h', '--help'):
                print help_message
                return 0
        
        if tags:
            for values in dicom_helper.read_dicom_tags(tags, *args):
                print "\t".join(values)
        elif summary:
            # Build the hierarchy.
            hierarchy = dicom_helper.read_image_hierarchy(*args)
            # Print each patient-visit-series-acquisition-image field.
            for path in hierarchy:
                print "\t".join(path)
            
        
    except Usage, err:
        print >> sys.stderr, sys.argv[0].split('/')[-1] + ': ' + str(err.msg)
        return 2
    
    return 0        

if __name__ == '__main__':
    sys.exit(main())
